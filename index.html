<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scarf-seams</title>
</head>

<body>
  <main>
    <h1>scarf-seams</h1>
    <p>
      This is a gcode post-processor for testing out "scarf seams" as
      discussed in <a href="https://github.com/prusa3d/PrusaSlicer/issues/11621">several</a>
      recent <a href="https://github.com/vgdh/seam-hiding-whitepaper">GitHub
        issues and projects.</a>
    </p>
    <p>
      Whereas those demos test out the process on simple cylinders, this
      project will convert any arbitrary model to use overlapping seams.
    </p>
    <p>
      Treat this as <em>extremely</em> experimental, as you would with any
      gcode post-processor. Preview the gcode in a slicer before sending it to
      your printer, and make sure it isn't doing anything wild. <strong>This
        tool is offered as is, and at your own risk.</strong>
    </p>
    <p>
      Theoretically, this should work with any printer that uses Marlin style
      gcode and absolute positioning during print moves. So far, I've tested
      it on my Bambulab X1C (with gcode from OrcaSlicer), and my Prusa mk3s+
      (with gcode from PrusaSlicer).
    </p>
    <p>
      <strong>Requirements:</strong>
    <ol>
      <li>Turn off arc fitting. This tool doesn't support them.</li>
      <li>You must use a fixed layer height. No variable heights, and the
        first layer must be at least as large as the remaining layers.</li>
      <li>Your printer must use Marlin style gcode. Other gcode formats are not supported.</li>
      <li>Positioning must be absolute.</li>
      <li>Extrusion must be relative</li>
      <li>Units are assumed to be in mm</li>
      <li>If you have a seam gap option, set it to zero</li>
    </ol>
    </p>
    <p>
      When possible, the tool will try to detect and warn you if these
      requirements aren't met, but you should still check to make sure by
      previewing the gcode.
    </p>
    <p>
      <strong>Be especially careful about the first layer height.</strong>
      Make sure that the layer height value you provide below is <strong>less
        than or equal</strong> to the first layer height you use in your slicer.
      The tool will try to protect your printer by never emitting any Z
      coordinate lower than the smallest value it sees, but if that goes
      wrong, your nozzle might crash into your print bed.
    </p>
    <form id="process-form">
      <label for="layer-height">Layer Height</label><input type="number" id="layer-height" value="0.2" step="0.01">
      <label for="overlap">Overlap Distance (mm)</label><input type="number" id="overlap" value="6">
      <label for="seam-gap">Seam Gap (mm)</label><input type="number" id="seam-gap" value="0.00" step="0.01">
      <label for="extrusion-factor">Extrusion Factor</label><input type="number" id="extrusion-factor" value=".9"
        step="0.01">
      <label for="choose-file">Choose a gcode file:</label>
      <input type="file" id="choose-file" accept=".gcode" />
      <button type="submit" id="process-button">Process</button>
      <h3>Advanced</h3>
      <label for="loop-tolerance">Loop Tolerance (mm)</label><input type="number" id="loop-tolerance" value="0.1"
        step="0.01">
      <label for="taper-resolution">Taper resolution (mm)</label><input type="number" id="taper-resolution" value="0.1"
        step="0.01">
    </form>
    <h2>How it works</h2>
    <p>
      This tool works by finding "closed loops" in the gcode, which are
      assumed to be perimeters. These loops are defined as sequences of G1
      commands where:
    <ol>
      <li>The Z coordinate is constant</li>
      <li>The extrusion is always positive</li>
      <li>The distance between the start and end points is less than the "loop tolerance"</li>
      <li>There are no intervening non-G1 commands</li>
    </ol>
    </p>
    <p>
      Once a closed loop is identified, the line segments making it up are
      accumulated until they reach the "overlap distance". If necessary, the
      final command is split into two parts, so that the total length of the
      command sequence is exactly the overlap distance. (If the entire length
      of the segment is less than the overlap distance, the segment is left
      alone.)
    </p>
    <p>
      This initial overlap is then split into shorter segments (roughly the
      "taper resolution" long). This sequence is then duplicated and appended
      to the end of the loop.
    </p>
    <p>
      The first copy of the modified sequence is tapered by multiplying the
      extrusion by a linear function varying from 0 to 1, and ramping the Z
      value based on the provided layer height.
    </p>
    <p>
      The second copy of the modified sequence is tapered by multiplying the
      extrusion by a linear function varying from 1 to 0. The Z value is left
      alone.
    </p>
  </main>
  <script type="module" src="/src/main.ts"></script>
</body>

</html>